name : EOP detection with Email Malware
description : 
- These queries are going to hunt for - Malware mails with Exchange Online Protection
- Case1 - EOP detection list 
- Case2 - Filter EOP detection based on detection methods
table : 
- EmailEvents
- https://learn.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-emailevents-table?view=o365-worldwide
query : |
    //Case1 - EOP detection list 
    EmailEvents
    | where Timestamp > ago(7d)
    | where isnotempty(DetectionMethods)
    | extend EOP_detection = parse_json(DetectionMethods)
    | where EOP_detection.Malware in 
      (
       @'["File reputation"]',
       @'["Antimalware engine"]',
       @'["URL malicious reputation"]'
      )
    | project Timestamp, Subject, NetworkMessageId, SenderFromAddress, RecipientEmailAddress, DeliveryLocation, EOP_detection.Malware


    //Case2 - Filter EOP detection based on detection methods
    EmailEvents
    | where Timestamp > ago(7d)
    | where isnotempty(DetectionMethods)
    | extend EOP_detection = parse_json(DetectionMethods)
    | where EOP_detection.Malware == @'["File reputation"]'
    //| where EOP_detection.Malware == @'["Antimalware engine"]'
    //| where EOP_detection.Malware == @'["URL malicious reputation"]'
    | project Timestamp, Subject, NetworkMessageId, SenderFromAddress, RecipientEmailAddress, DeliveryLocation, EOP_detection.Malware
